<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Canvas tutorial</title>
    <!--就知道你会查看源代码，哈哈~-->
    <!--时间匆忙，代码有点乱，不要在意这些细节-->
    <!--前两天刚学了js，现学现用-->
    <!--用了一天多的时间，自己构思效果，然后再自己实现-->
    <!--不要迷恋哥，哥只是传说！-->
    <!--虽然是传说，还是5 2 0！-->
    <script type="text/javascript">
        var configs = {
            text : "why520", // 输出的字符串
            textFill : true, // 是否填充绘制字符串
            dotColor : "grey",
            dotStyle : "circle", // circle / rect
            dotInterval : 100, // 创建点的间隔
            dotRadius : 4, // 每个点的半径
            debug : false, // 是否显示一个用于调试的canvas
            multiple : 8 // 两个canvas之间的倍数
        };

        function load() {

            function Point(x, y) {
                this.x = x;
                this.y = y;
            }

            /**
             *
             * @param cur Point
             * @param to Point
             * @param color string
             * @constructor
             */
            function Dot(cur, to, color) { // http://www.w3school.com.cn/js/pro_js_object_defining.asp
                this.cur = cur;
                this.to = to;
                this.color = color;

                this.dx = (this.to.x - this.cur.x) / 200;
                this.dy = (this.to.y - this.cur.y) / 200;
            }
            /**
             * 是否已到达目标点
             */
            Dot.prototype.reachedDst = function () {
                // 只需判断一个方向即可（这里取x）
                // 符号相反表示已到；利用抑或判断符号 (http://w3school.com.cn/js/pro_js_operators_bitwise.asp)
//                return (this.dx ^ (this.to.x - this.cur.x)) < 0; // 似乎浮点数不能用这种方法。。。
                var delta = this.to.x - this.cur.x;
                return this.dx < 0 && delta > 0 || this.dx > 0 && delta < 0;
            };

            // http://www.xiaomeiti.com/note/3589
            Math.seed = 0;
            Math.seededRandom = function(max, min) {
                max = max || 1;
                min = min || 0;

                Math.seed = (Math.seed * 9301 + 49297) % 233280;
                var rnd = Math.seed / 233280.0;

                return min + rnd * (max - min);
            };

            var
                    canvas = document.getElementById("canvas"), // 显示目标图像的canvas
                    ctx = canvas.getContext("2d"),
                    imageData, // 保存了字符串每个像素点颜色信息（RGBA）（https://developer.mozilla.org/zh-CN/docs/Web/API/ImageData）
                    helperCanvasWidth,
                    textDots = [], // text的字符串点阵：[point, ...]
                    textDotCount, // textDots的长度

                    movingDots = [], // 运动中的点集：[dot, ...]
                    reachedDots = [], // 已经到达位置的点集：[dot, ...]
                    bufferedDots = [], // 准备加入movingDots中但需要等待下次draw被调用的点集：[dot, ...]

                    curPoi = new Point(0, 0), // 鼠标当前点
                    mouseTimer, // 定时器

                    onTextShowedCalled = false,
                    i // 遍历用。。。
            ;

            //设置canvas的高宽
            function setCanvasSize() {
                canvas.width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                canvas.height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
//                alert(canvas.width + ", " + canvas.height);
            }

            function bufferDots() {
                for (i = 0; i < 3; i++) { // 一次生成多个点
                    if (textDots.length == 0) {
                        break;
                    }
                    var
                            randomIndex = randomInt(textDots.length),
                            dot = textDots[randomIndex],
                            cur = new Point(curPoi.x, curPoi.y),
                            to = new Point(dot.x * configs.multiple, dot.y * configs.multiple)
                            ;
                    bufferedDots.push(new Dot(cur, to, randomColor()));
                    textDots.splice(randomIndex, 1); // remove
                }
            }

            function hasPixIn(x, y) { // 从imageData取(x,y)点看是否为非透明
                var n = y * helperCanvasWidth + x; // 取第n个像素点
                // 看RGBA中的A是否为0
                return imageData.data[4 * n + 3] != 0;
            }

            /**
             * 返回从0到max之间的随机整数：[0, max)
             */
            function randomInt(max) {
                return Math.floor((Math.seededRandom() * max));
            }

            function randomColor() {
                var
                        r = randomInt(255),
                        g = randomInt(255),
                        b = randomInt(255)
                ;
                return "rgb(" + r + "," + g + "," + b + ")";
            }

            /**
             * 周期性执行指定函数
             * @type {*|Function}
             */
            var frameFunc = window.requestAnimationFrame
                    || window.webkitRequestAnimationFrame
                    || window.mozRequestAnimationFrame
                    || window.oRequestAnimationFrame
                    || window.msRequestAnimationFrame
                    || function (func) {
                        window.setTimeout(func, 1000 / 45);
                    };

            //初始化画布大小
            setCanvasSize();
            window.onresize = setCanvasSize;
            window.onmousedown = function() {
                mouseTimer =  window.setInterval(bufferDots, configs.dotInterval);
                document.getElementById("tips").style.display="none";
            };
            window.onmouseup = function() {
                window.clearInterval(mouseTimer);
            };
            window.onmousemove = function(e) {
                curPoi.x = e.clientX;
                curPoi.y = e.clientY;
            };

            /**
             * 当文字完全显示出来后
             */
            function onTextShowed() {
                document.getElementById("text").style.display = "block";
            }

            !function getImageData() {
                var helperCanvas = document.getElementById("test");
                helperCanvas.width = canvas.width / configs.multiple;
                helperCanvas.height = canvas.height / configs.multiple;
                if (!configs.debug) {
                    helperCanvas.style.display = "none";
                }
                var helperCtx = helperCanvas.getContext("2d");

                helperCtx.font = "30px serif";
                helperCtx.textBaseline = "middle";
                helperCtx.textAlign = "center";
                helperCtx.fillStyle = "rgb(0,0,0)";
                if (configs.textFill) {
                    helperCtx.fillText(configs.text, helperCanvas.width / 2, helperCanvas.height / 2);
                } else {
                    helperCtx.strokeText(configs.text, helperCanvas.width / 2, helperCanvas.height / 2);
                }
                helperCanvasWidth = helperCanvas.width;
                imageData = helperCtx.getImageData(0, 0, helperCanvas.width, helperCanvas.height); // 以canvas的高度作为字体暂时的高度（大于实际高度）
                for (var y = 0; y < helperCanvas.height; y++) { // 横向查找（如果x在外层循环，则为纵向查找）
                    for (var x = 0; x < helperCanvas.width; x++) {
                        if (hasPixIn(x, y)) {
                            textDots.push(new Point(x, y));
//                            textHeight = y;
                        }
                    }
                }
                textDotCount = textDots.length;
//                alert("textDots:" + textDots.length);
//                alert(textWidth + "," + textHeight);
            }();

            !function draw(){
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                movingDots = movingDots.concat(bufferedDots);
                bufferedDots = []; // 清空buffer
                for (i = movingDots.length - 1; i >= 0 ; i--) { // 有删除操作，需要倒序遍历
                    var movingDot = movingDots[i];
                    movingDot.cur.x += movingDot.dx;
                    movingDot.cur.y += movingDot.dy;
                    if (movingDot.reachedDst()) {
                        movingDots.splice(i, 1); // remove
//                        movingDot.color = "black";
                        reachedDots.push(movingDot);
                    } else {
                        ctx.fillStyle = movingDot.color;
                        ctx.beginPath();
                        if (configs.dotStyle == "circle") {
                            ctx.arc(movingDot.cur.x, movingDot.cur.y, configs.dotRadius, 0, 2 * Math.PI);
                        } else if (configs.dotStyle == "rect") {
                            ctx.rect(movingDot.cur.x - configs.dotRadius, movingDot.cur.y - configs.dotRadius, 2 * configs.dotRadius, 2 * configs.dotRadius); // 画矩形效果没有圆形好。。。
                        }
                        ctx.fill();
                    }
                }

                // draw reachedDots
                for (i in reachedDots) {
                    var reachedDot = reachedDots[i];
                    ctx.fillStyle = reachedDot.color;
                    ctx.beginPath();
                    if (configs.dotStyle == "circle") {
                        ctx.arc(reachedDot.to.x, reachedDot.to.y, configs.dotRadius, 0, 2 * Math.PI);
                    } else if (configs.dotStyle == "rect") {
                        ctx.rect(reachedDot.to.x - configs.dotRadius, reachedDot.to.y - configs.dotRadius, 2 * configs.dotRadius, 2 * configs.dotRadius); // 画矩形效果没有圆形好。。。
                    }
                    ctx.fill();
                }
                if (reachedDots.length >= textDotCount - 3 && !onTextShowedCalled) { // todo 有bug来不及找，偶尔会有一两个点消失，所以先-3
                    onTextShowedCalled = true;
                    onTextShowed();
                }
                frameFunc(draw);
            }();
        }
    </script>
    <style type="text/css">
        canvas {
            position:fixed;
            top:0;
            left:0;
        }
        canvas#test { /*for debug*/
            border: 1px solid black;
        }
        pre {
            color:#FF10F7;
            text-align: center;
            font-size: 50px;
            font-weight: bold;
            display:none;
        }
        p {
            text-align: center;
            font-size: 50px;
            font-weight: bold;
        }
    </style>
</head>
<body onload="load();">
<p id="tips">按住鼠标左键到处晃晃看？</p>
<pre id="text">海英,5201314！</pre>
<canvas id="canvas"></canvas>
<canvas id="test" width=500 height=500></canvas>
</body>
</html>
